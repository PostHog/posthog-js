name: Minimum TypeScript version check

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  unit:
    name: Check minimum TS version
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        node-version: [20, 22, 24]
        typescript-version:
          - version: "4.7.4"
            extra-flags: "--moduleResolution node"
          - version: "5.9.2"
            extra-flags: "--moduleResolution node"
          - version: "6.0.0-dev.20251204"
            extra-flags: "--ignoreConfig"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup
        with:
          node_version: ${{ matrix.node-version }}
          build: true

      # once its built we can see if we can use it on the forced version
      - name: Override TypeScript version
        env:
          TS_VERSION: ${{ matrix.typescript-version.version }}
        run: yq -i '.catalog.typescript = strenv(TS_VERSION)' pnpm-workspace.yaml && pnpm install --no-frozen-lockfile

      - name: Test TypeScript Import
        run: |
          rm ci-ts-file.js || true
          pnpm exec tsc --version
          pnpm exec tsc ci-ts-file.ts --strict --target es2017 --module commonjs --skipLibCheck ${{ matrix.typescript-version.extra-flags }}
          node ci-ts-file.js
        working-directory: packages/browser
